services:
  - type: web
    name: alnakheel-api
    env: node
    plan: free
    region: oregon

    buildCommand: |
      npm ci
      npx prisma generate
      npx prisma migrate deploy || npx prisma db push
      npm run build

    startCommand: npm run start
    postDeployCommand: npm run prisma:seed

    envVars:
      - key: DATABASE_URL
        fromService:
          name: alnakheel
          type: postgres
          property: connectionString
      - key: NODE_ENV
        value: production
      - key: PRISMA_CLIENT_ENGINE_TYPE
        value: binary

    healthCheckPath: /api/health
    autoDeploy: true

  - type: postgres
    name: alnakheel
    plan: free
    region: oregon
    databaseName: alnakheel
    user: alnakheel_user
    postgresMajorVersion: 15
    ipAllowList: []
